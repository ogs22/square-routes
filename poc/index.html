<!DOCTYPE html>
<html lang="en">

<head>
    <script src="tile.js"></script>
    <script src="decode.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.css">

    <script
            src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.3.1/leaflet.js"></script>
    <meta charset="UTF-8">
    <title>Squars</title>
</head>
<body>
<div id="map_id" style="width:100%;height:500px;"></div>
<div id="gpx" style="width:100%;height:500px;"></div>
<script>
    let offset = 0.5;
    let zoom = 14;
    let startx = 8213;
    let starty = 5412;
    let coords = [];
    let data = [];
    for (let x = 0; x < 8; x++) {
        for (let y = 0; y < 8; y++) {
            let thislong = tile2long(startx + x + offset, zoom);
            let thislat = tile2lat(starty + y + offset, zoom);
            locate(thislong, thislat, startx + x, starty + y);
        }
    }
    //console.log(data);

    let coordjson = [];
    let locations = {"locations": [], "costing": "bicycle", "directions_options": {"units": "miles"}};
    for (let i = 0; i < data.length; i++) {
        coordjson[i] = {
            "coordinate":
                [data[i][0].edges[0].correlated_lat, data[i][0].edges[0].correlated_lon],
            "Indirizzo": "Sqr " + data[i].sqrx + ' ' + data[i].sqry
        };
        locations.locations[i] = {"lat": data[i][0].edges[0].correlated_lat, "lon": data[i][0].edges[0].correlated_lon}
    }
    //console.log(coordjson);

    var map_var = L.map('map_id').setView([51.937633, 0.56022], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map_var);

    domapstuff(coordjson);


    //console.log(locations);


    let url = 'http://localhost:8002/optimized_route?json=' + JSON.stringify(locations);
    //console.log(url);

    data = [];
    var xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
            data = JSON.parse(xhttp.responseText);
        }
    };
    xhttp.open("GET", url, false);
    xhttp.send();

    // console.log(data);
    let points = [];
    let legs = data.trip.legs;
    for (let j = 0; j < legs.length; j++) {

        let pline = plinedecode(legs[j].shape);
        console.log(pline);
        console.log(j);
        points = points.concat(pline);
    }
    //console.log(points);
    let gpxstring ="   <?xml version=\"1.0\" encoding=\"UTF-8\"?>\n" +
        "   <gpx creator=\"StravaGPX\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/1/gpx.xsd\" version=\"1.1\" xmlns=\"http://www.topografix.com/GPX/1/1\">\n" +
        "    <metadata>\n" +
        "     <name>sunday</name>\n" +
        "     <author>\n" +
        "      <name>Owen Ogg Smith</name>\n" +
        "      <link href=\"https://www.strava.com/athletes/609144\"/>\n" +
        "     </author>\n" +
        "    </metadata>\n" +
        "    <trk>\n" +
        "     <name>test ride</name>\n" +
        "     <type>Ride</type>\n" +
        "     <trkseg>";
    for (let k=0; k < points.length;k++){
        gpxstring += '   <trkpt lat="'+ points[k][0]+'" lon="'+ points[k][1]+'">\n' +
            // '    <ele>15.530000000000001</ele>\n' +
            '   </trkpt>'
    }

    gpxstring += '     </trkseg>\n' +
        '    </trk>\n' +
        '   </gpx>';

    console.log(gpxstring);

</script>


</body>
</html>